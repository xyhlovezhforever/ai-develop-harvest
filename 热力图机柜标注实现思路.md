# 热力图机柜标注实现思路

## 功能概述

在热力图上绘制固定位置的机柜矩形边框和通道标注。采用全局静态定义结合 ECharts graphic API 的方案，完全参照 H5 版本（`index - 副本.vue`）实现。

## 核心设计

### 1. 框线数据结构

采用**全局静态定义**的方式，预定义10个通道的矩形位置：

```typescript
let rectPositions = {
  one: {
    positions: [
      [3, 24],        // 左上
      [22, 24],       // 右上
      [3, 68],        // 左下
      [22, 68],       // 右下
    ],
    name: '1号通道',
  },
  // ... two to nine ...
  ten: {
    positions: [
      [107, 73],
      [126, 73],
      [107, 117],
      [126, 117],
    ],
    name: '10号通道',
  },
}

// 转换为数组格式，便于遍历
const rectPositionsArray = Object.values(rectPositions)
```

**特点**：
- 使用物理坐标系（0-135 范围）
- 预定义10个通道位置
- 结构包含4个顶点坐标和通道名称
- 易于扩展或修改位置

### 2. 坐标转换

使用三步坐标转换将物理坐标映射到像素坐标：

```typescript
// 第1步：物理坐标 (0-135) → 数据坐标 (0-cols/rows)
const topLeftGrid = [
  (topLeftPhys[0] / 135) * (cols - 1),
  (topLeftPhys[1] / 135) * (rows - 1)
]

// 第2步：数据坐标 → 像素坐标
const pixelTopLeft = chartInstance!.convertToPixel(
  { gridIndex: 0 },
  topLeftGrid
)

// 第3步：计算矩形宽高
const width = pixelBottomRight[0] - pixelTopLeft[0]
const height = pixelBottomRight[1] - pixelTopLeft[1]
```

**关键参数**：
- `135`：物理坐标系的最大值
- `cols - 1`、`rows - 1`：数据坐标的范围
- `gridIndex: 0`：ECharts 的第一个网格

### 3. 框线绘制 - Graphic API

使用 ECharts 的 `graphic` 组件在 `nextTick` 回调中绘制：

```typescript
nextTick(() => {
  const graphics: any = []
  const cols = xAxisData.length
  const rows = yAxisData.length
  
  rectPositionsArray.forEach((rect: any, index: number) => {
    if (rect.positions && rect.positions.length === 4) {
      const [topLeftPhys, topRightPhys, bottomLeftPhys, bottomRightPhys] = rect.positions
      
      // 坐标转换（如上所述）
      const topLeftGrid = [(topLeftPhys[0] / 135) * (cols - 1), (topLeftPhys[1] / 135) * (rows - 1)]
      const bottomRightGrid = [(bottomRightPhys[0] / 135) * (cols - 1), (bottomRightPhys[1] / 135) * (rows - 1)]
      
      const pixelTopLeft = chartInstance!.convertToPixel({ gridIndex: 0 }, topLeftGrid)
      const pixelBottomRight = chartInstance!.convertToPixel({ gridIndex: 0 }, bottomRightGrid)
      
      if (pixelTopLeft && pixelBottomRight) {
        const x = pixelTopLeft[0]
        const y = pixelTopLeft[1]
        const width = pixelBottomRight[0] - pixelTopLeft[0]
        const height = pixelBottomRight[1] - pixelTopLeft[1]
        
        // 添加矩形边框
        graphics.push({
          type: 'rect',
          shape: { x, y, width, height },
          style: {
            stroke: '#1a1a1a',  // 暗色边框
            fill: 'none',
            lineWidth: 2,
          },
          z: 100,
        })
        
        // 添加文字标签（参考下节）
        // ...
      }
    }
  })
  
  // 将所有图形添加到图表
  if (graphics.length > 0) {
    chartInstance!.setOption({
      graphic: graphics,
    }, { notMerge: false, lazyUpdate: false })
  }
})
```

**优势**：
- ✅ 在 `nextTick` 中执行，确保 ECharts 已初始化
- ✅ 支持像素级精确控制
- ✅ 性能好，不依赖额外的数据系列
- ✅ 与 H5 版本完全一致

### 4. 文字标签绘制

每个通道都绘制竖排文字标签：

```typescript
const centerX = x + width / 2
const centerY = y + height / 2
const channelText = rect.name || `通道${index + 1}`  // 如 "1号通道"
const fontSize = Math.max(12, Math.floor(width * 0.15))

// 将文字分解为单个字符，竖排显示
const textLines = channelText.split('').map((char: string, idx: number) => {
  return {
    type: 'text',
    position: [
      centerX,
      centerY - (channelText.length - 1) * fontSize / 2 + idx * fontSize
    ],
    style: {
      text: char,
      textAlign: 'center',
      textVerticalAlign: 'middle',
      fill: '#1a1a1a',  // 暗色文字
      fontSize: fontSize,
      fontWeight: 'bold',
    },
    z: 101,  // 高于矩形边框
  }
})

graphics.push(...textLines)
```

**特点**：
- 竖排显示文字
- 字体大小自适应（矩形宽度的15%）
- 文字居中于矩形
- 使用暗色 (#1a1a1a) 确保清晰度

## 数据流程

```
原始热力图数据
    ↓
插值处理（Worker线程或主线程）
    ↓
提取 xAxisData 和 yAxisData
    ↓
ECharts 初始化并渲染热力图
    ↓
nextTick 回调触发
    ↓
遍历 rectPositionsArray
    ↓
坐标转换（物理→数据→像素）
    ↓
构建 graphic 对象（矩形 + 文字）
    ↓
setOption 添加 graphic
    ↓
热力图上显示框线和标注
```

## 工作流程

### 初始化阶段

1. 定义全局 `rectPositions` 对象（固定的10个通道）
2. 转换为 `rectPositionsArray` 数组
3. 初始化 ECharts 实例

### 数据加载阶段

1. 从 mock 数据或 API 获取热力图数据
2. 通过 Worker 或主线程进行数据处理（插值、范围计算等）
3. 调用 `updateChart()` 函数

### 图表渲染阶段

1. 生成 ECharts option 配置
2. 调用 `setOption` 渲染热力图
3. 在 `nextTick` 中添加 graphic 框线和文字
4. 完成渲染

## 关键代码位置

| 功能 | 位置 | 行号范围 |
|------|------|---------|
| 框线数据定义 | `src/pages/heatmap/index.vue` | 120-215 |
| 框线数据转换 | `src/pages/heatmap/index.vue` | 217 |
| 框线绘制（nextTick） | `src/pages/heatmap/index.vue` | 1130-1207 |
| 坐标转换 | `src/pages/heatmap/index.vue` | 1143-1145 |
| 矩形边框 graphic | `src/pages/heatmap/index.vue` | 1156-1173 |
| 文字标签 graphic | `src/pages/heatmap/index.vue` | 1181-1198 |

## 可配置参数

| 参数 | 位置 | 说明 |
|------|------|------|
| 通道位置 | `rectPositions.*` | 10个通道的矩形坐标 |
| 通道名称 | `rectPositions.*.name` | 每个通道的显示名称 |
| 边框颜色 | graphic.style.stroke | 当前为 `#1a1a1a`（暗色） |
| 边框宽度 | graphic.style.lineWidth | 当前为 `2` |
| 文字颜色 | graphic.style.fill | 当前为 `#1a1a1a`（暗色） |
| 文字大小系数 | `Math.floor(width * 0.15)` | 矩形宽度的15% |
| 物理坐标范围 | 坐标转换公式 | 分母 `135` |

## 修改通道位置

修改 `rectPositions` 对象中的坐标值即可：

```typescript
// 示例：修改1号通道位置
one: {
  positions: [
    [5, 30],      // 新的左上坐标
    [24, 30],     // 新的右上坐标
    [5, 75],      // 新的左下坐标
    [24, 75],     // 新的右下坐标
  ],
  name: '1号通道',
}
```

## 修改显示样式

### 边框颜色

```typescript
// 在 graphic 对象中
style: {
  stroke: '#FF6666',  // 改为红色
  fill: 'none',
  lineWidth: 2,
}
```

### 文字大小

```typescript
// 调整系数（默认0.15，范围0.1-0.3）
const fontSize = Math.max(12, Math.floor(width * 0.2))  // 改为20%
```

### 文字排列

当前为竖排，若要改为横排：

```typescript
// 改为横排：所有字符在同一行
position: [centerX + idx * fontSize, centerY]
```

## 与 H5 版本差异

| 方面 | 小程序版本 | H5 版本 | 说明 |
|------|-----------|--------|------|
| 数据来源 | Mock数据 | API 调用 | 小程序使用本地 mock 数据 |
| 框线类型 | Graphic API | Graphic API | 完全相同 |
| 坐标系统 | 物理坐标(0-135) | 物理坐标(0-135) | 完全相同 |
| 文字显示 | 竖排 | 竖排 | 完全相同 |
| 边框颜色 | #1a1a1a | #1a1a1a | 完全相同 |

## 性能特点

- ✅ 固定10个通道，无需检测，性能稳定
- ✅ 使用 graphic API，渲染效率高
- ✅ nextTick 保证时序正确
- ✅ 坐标转换使用缓存的 cols/rows
- ✅ 支持移动端和桌面端

## 注意事项

1. **坐标系统**：使用的是物理坐标(0-135)，不是像素坐标
2. **nextTick 时序**：必须在 nextTick 中执行，确保 ECharts 已初始化
3. **cols/rows 计算**：必须从 xAxisData 和 yAxisData 获取
4. **浮点精度**：坐标转换中涉及浮点计算，已内置处理
5. **文字显示**：竖排显示需要分解为单个字符

## 对标文件

- **小程序实现**：`src/pages/heatmap/index.vue` (1130-1207 行)
- **H5 参考**：`src/pages/heatmap/index - 副本.vue` (970-1046 行)

## 版本更新

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2025-11-20 | 使用全局静态 rectPositions + Graphic API + nextTick |
| 1.1 | 2025-11-20 | 完全参照 H5 版本，坐标转换和数据结构完全一致 |
