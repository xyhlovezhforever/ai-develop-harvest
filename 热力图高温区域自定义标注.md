# 热力图机柜标注实现思路

## 功能概述

在热力图上自动检测高温区域（机柜位置），并为每个机柜绘制矩形边框、分隔线和通道编号文字标注。

## 核心功能

### 1. 高温区域自动检测

**目标**：从热力图数据中自动识别出机柜所在的高温区域

**实现步骤**：

1. **数据预处理**
   - 使用 `Map` 数据结构存储热力图数据点，提高查找效率（O(1)）
   - 格式：`Map<"x,y", temperature>`

2. **列温度统计**
   - 遍历每一列（x坐标），计算该列的平均温度
   - 只采样中间80%的区域（10%-90%），提高计算速度
   - 公式：`colTemps[x] = sum(temperatures) / count`

3. **高温阈值计算**
   - 动态阈值：`threshold = minTemp + (maxTemp - minTemp) * 0.55`
   - 0.55系数可根据实际情况调整

4. **高温列检测**
   - 遍历所有列，找出温度超过阈值的连续区域
   - 使用状态机模式：
     - `inHotZone = false`：未进入高温区
     - `inHotZone = true`：正在高温区内
   - 记录每个高温区域的所有列索引

5. **中心点计算**
   - 使用加权平均计算每个高温区域的中心列
   - 公式：`center = floor(sum(x) / count)`

### 2. 机柜矩形生成

**配置参数**：
```javascript
const unifiedWidth = 15  // 统一矩形宽度
const upperY = 20        // 上层机柜Y坐标
const lowerY = 155       // 下层机柜Y坐标
const height = 110       // 矩形高度
```

**生成规则**：
- 每个检测到的高温列中心生成2个机柜（上层和下层）
- 矩形以中心点为基准，向两侧扩展
- X坐标：`x = centerX - floor(width / 2)`

### 3. 矩形边框绘制

**使用 ECharts markLine 组件**

每个矩形由4条线组成：

```javascript
// 上边
[{ coord: [x, y] }, { coord: [x + width, y] }]

// 下边
[{ coord: [x, y + height] }, { coord: [x + width, y + height] }]

// 左边
[{ coord: [x, y] }, { coord: [x, y + height] }]

// 右边
[{ coord: [x + width, y] }, { coord: [x + width, y + height] }]
```

**样式配置**：
- 颜色：橙色 `#ff6600`
- 宽度：2.5
- 类型：实线 `solid`
- 层级：`z: 100`

### 4. 分隔线绘制

**位置**：
- 左侧竖线：`x + width / 3`
- 右侧竖线：`x + width * 2 / 3`

**样式配置**：
- 颜色：浅蓝色 `#66ccff`
- 宽度：1.5
- 类型：虚线 `dashed`
- 条件：只有宽度 > 8 时才绘制

### 5. 通道文字标注

**使用 ECharts markPoint 组件**

**编号规则**：
- 上层机柜（偶数索引 0,2,4,6,8）：1-5号通道
- 下层机柜（奇数索引 1,3,5,7,9）：6-10号通道
- 公式：
  ```javascript
  channelNumber = index % 2 === 0 
    ? floor(index / 2) + 1      // 上层
    : floor(index / 2) + 6      // 下层
  ```

**文字样式**：
- 显示方式：竖排（每个字符用 `\n` 分隔）
- 字体大小：矩形宽度的一半 `floor(width / 2)`
- 颜色：黑色 `#000000`
- 位置：矩形中心点 `[x + width/2, y + height/2]`

## 性能优化

### 1. 数据结构优化
- 使用 `Map` 替代 `Array.find()`，查找复杂度从 O(n) 降到 O(1)

### 2. 采样优化
- 只采样中间80%区域计算列温度，减少计算量

### 3. 渲染优化
- 设置 `animation: false` 关闭动画
- 使用 `notMerge: true` 直接替换配置
- 设置 `progressive: 0` 关闭渐进式渲染

## 数据流程

```
原始热力图数据
    ↓
插值处理（Worker线程）
    ↓
构建温度Map
    ↓
计算列平均温度
    ↓
检测高温列
    ↓
计算中心点
    ↓
生成机柜矩形
    ↓
绘制边框、分隔线、文字
    ↓
ECharts渲染
```

## 关键代码位置

- **检测函数**：`detectRacks()` (line 577-656)
- **边框绘制**：`markLine.data` (line 889-936)
- **文字标注**：`markPoint.data` (line 953-980)
- **ECharts配置**：`option` (line 661-984)

## 可配置参数

| 参数 | 位置 | 默认值 | 说明 |
|------|------|--------|------|
| `threshold` | line 582 | `0.55` | 高温阈值系数 |
| `unifiedWidth` | line 644 | `15` | 统一矩形宽度 |
| `upperY` | line 650 | `20` | 上层Y坐标 |
| `lowerY` | line 652 | `155` | 下层Y坐标 |
| `height` | line 650 | `110` | 矩形高度 |
| `borderColor` | line 893 | `#ff6600` | 边框颜色 |
| `borderWidth` | line 894 | `2.5` | 边框宽度 |
| `dividerColor` | line 921 | `#66ccff` | 分隔线颜色 |
| `dividerWidth` | line 922 | `1.5` | 分隔线宽度 |

## 注意事项

1. **坐标系统**：使用数据坐标系，不是像素坐标系
2. **插值比例**：需要考虑数据插值后的坐标范围变化
3. **边界处理**：确保最后一个高温区域也被正确检测
4. **宽度统一**：所有矩形使用统一宽度，避免重叠
5. **字体自适应**：字体大小根据矩形宽度动态计算

## 未来优化方向

1. 支持自定义颜色配置
2. 支持不同楼层的不同标注样式
3. 添加机柜详细信息的 tooltip
4. 支持点击机柜查看详细数据
5. 优化小屏幕设备的显示效果
